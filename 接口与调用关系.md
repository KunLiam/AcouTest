# 声测大师(AcouTest) 接口与调用关系

本文档整理**从 UI 到底层**、**从大类到小类**的整条调用链，便于排查“点按钮调谁”“功能在哪个文件实现”。

---

## 一、架构分层（谁调谁）

```
┌─────────────────────────────────────────────────────────────────┐
│  入口：main.py → AudioTestTool(root)                             │
│  AudioTestTool = UIComponents + DeviceOperations + TestOperations │
└─────────────────────────────────────────────────────────────────┘
                                    │
        ┌───────────────────────────┼───────────────────────────┐
        ▼                           ▼                           ▼
┌───────────────┐         ┌───────────────────┐         ┌─────────────────┐
│ ui_components │         │ test_operations   │         │ devices_operations │
│ (UI 层)       │ ──────► │ (业务/测试逻辑层)  │ ──────► │ (设备/ADB 层)   │
│               │ 调用   │                   │ 调用    │                 │
│ - 画界面      │         │ - 开始/停止测试   │         │ - 刷新设备列表  │
│ - 绑定 command│         │ - 拉取文件/截图   │         │ - 选设备        │
│ - 弹窗/子窗口 │         │ - Logcat/扫频等   │         │ - get_adb_command│
└───────────────┘         └───────────────────┘         │ - check_device  │
        │                           │                    └─────────────────┘
        │                           │
        └──────────────────────────┴────────────────────────────────────
                                    │
                    共用：feature_config.py（功能开关）
                           output_paths.py（输出目录）
```

- **UI 层**：所有“按钮点了谁”的 `command=` 都在 `ui_components.py` 里绑定；部分逻辑直接写在 UI 类（如烧elevockey 的 _do_read/_do_burn）。
- **业务层**：`test_operations.py` 实现具体测试流程（麦克风、HAL、Logcat、扫频、遥控器等），内部会调 `get_adb_command()`、`check_device_selected()`。
- **设备层**：`devices_operations.py` 只负责设备列表、当前设备、ADB 命令拼接，不画界面。

---

## 二、大类 → 小类 结构（与 feature_config 一致）

功能是否显示由 `feature_config.py` 的 `MAIN_TABS` / `SUB_TABS` 控制。

| 大类（主标签） | 小类（子标签/页面） | 界面入口函数 | 说明 |
|----------------|---------------------|--------------|------|
| **硬件测试** | 
| | 麦克风测试 | `setup_mic_tab()` / `open_mic_window()` | 多麦录音 |
| | 雷达检查 | `setup_radar_tab()` / `open_radar_window()` | TTY/Logcat/AIEQ |
| | 喇叭测试 | `setup_speaker_tab()` / `open_speaker_window()` | 喇叭播放测试 |
| | 多声道测试 | `setup_multichannel_tab()` / `open_multichannel_window()` | 7.1 等多声道 |
| **声学测试** | 
| | 扫频测试 | `setup_sweep_tab()` / `open_sweep_window()` | 单次/批量扫频 |
| **音频调试** | 
| | Loopback和Ref测试 | `setup_loopback_tab()` / `open_loopback_window()` | 回路/Ref 测试 |
| | HAL录音 | `setup_hal_recording_tab()` / `open_hal_window()` | HAL 属性录音 + 拉取 |
| | Logcat日志 | `setup_logcat_tab()` | 属性开关、抓取、日志查看器 |
| | 唤醒监测 | `setup_hotword_monitor_tab()` | 唤醒次数统计 |
| | 系统指令 | `setup_system_cmd_tab()` | 预设命令 + 自定义指令 |
| **常用功能** | 
| | 遥控器 | `setup_remote_tab()` / `open_remote_window()` | 按键 + 快捷应用 |
| | 本地播放 | `setup_local_playback_tab()` / `open_playback_window()` | 本机/设备播放 |
| | 截图功能 | `setup_screenshot_tab()` / `open_screenshot_window()` | 设备截图 |
| **烧大象key** | 
| | u盘烧key | `setup_ukey_burn_tab()` | UUID → 烧Key → 检查 |
| | sn烧key | `setup_sn_key_burn_tab()` | 烧elevockey / 重写设备SN |

---

## 三、各小类：UI 操作 → 调用的接口（文件与方法）

以下按「大类 → 小类」列出主要按钮/操作及其**最终调用的方法**与**所在文件**。

### 3.1 设备区（全局）

| UI 操作 | 调用方法 | 文件 |
|---------|----------|------|
| 刷新设备列表 | `refresh_devices()` | devices_operations.py |
| 选择设备 | `on_device_selected()` | devices_operations.py |
| 检查是否已选设备 | `check_device_selected()` | devices_operations.py |
| 组装 ADB 命令 | `get_adb_command(cmd)` | devices_operations.py |

---

### 3.2 硬件测试

#### 麦克风测试

| UI 操作 | 调用方法 | 文件 |
|---------|----------|------|
| 开始麦克风测试 | `start_mic_test()` | test_operations.py |
| 停止录制 | `stop_mic_test()` | test_operations.py |
| 浏览保存路径 | `browse_mic_save_path()` | test_operations.py |

#### 雷达检查

| UI 操作 | 调用方法 | 文件 |
|---------|----------|------|
| 各子页（TTY/Logcat/AIEQ） | 在 `setup_radar_tab()` 内通过 handler 传入 | ui_components.py |

#### 喇叭测试

| UI 操作 | 调用方法 | 文件 |
|---------|----------|------|
| 浏览音频 / 添加默认音频 | `browse_speaker_audio()` / `add_default_audio_file()` | test_operations.py |
| 开始喇叭测试 | `start_speaker_test()` | test_operations.py |

#### 多声道测试

| UI 操作 | 调用方法 | 文件 |
|---------|----------|------|
| 开始测试 | `run_multichannel_test()` | test_operations.py |
| 停止测试 | `stop_multichannel_test()` | test_operations.py |

---

### 3.3 声学测试

#### 扫频测试

| UI 操作 | 调用方法 | 文件 |
|---------|----------|------|
| 开始单次/批量测试 | `start_sweep_test(handler)` | ui_components.py（内部调 test_operations 的播放/录制逻辑） |
| 停止测试 | `stop_sweep_test(handler)` | ui_components.py |
| 浏览保存路径 / 添加扫频文件 | `browse_sweep_save_path()` / `add_custom_sweep_file()` 等 | test_operations.py |

---

### 3.4 音频调试

#### Loopback和Ref测试

| UI 操作 | 调用方法 | 文件 |
|---------|----------|------|
| 浏览音频 / 浏览保存路径 | `browse_audio_file()` / `browse_loopback_save_path()` | test_operations.py / ui_components.py |
| 开始测试 | `run_loopback_test()` | ui_components.py（内用 test_operations 的 tinyplay/tinycap 等） |
| 停止录制 | `stop_loopback_test()` | ui_components.py |

#### HAL录音

| UI 操作 | 调用方法 | 文件 |
|---------|----------|------|
| 添加属性 | `add_hal_prop()` | test_operations.py |
| 全选/取消全选 | `toggle_hal_props()`（或同类） | ui_components.py |
| 创建目录 / 检查目录 | `create_hal_dir()` / `check_hal_dir()` | test_operations.py |
| 浏览保存路径 | `browse_hal_save_path()` | test_operations.py |
| 开始录音 | `start_hal_recording()` | test_operations.py |
| 停止录音 | `stop_hal_recording()` | test_operations.py（后台线程：关属性 + `_auto_pull_hal_files_impl()`） |
| 打开文件夹 | `open_hal_folder()` | ui_components.py |

#### Logcat日志

| UI 操作 | 调用方法 | 文件 |
|---------|----------|------|
| 添加属性 | `add_logcat_prop()` | test_operations.py |
| 放开打印 | `enable_logcat_debug()` | test_operations.py |
| 停止打印 | `disable_logcat_debug()` | test_operations.py |
| 开始抓取 | `start_logcat_capture()` | test_operations.py |
| 停止抓取 | `stop_logcat_capture()` | test_operations.py |
| 打开日志查看器 | `open_logcat_viewer_window()` | ui_components.py（弹窗类 LogcatViewerWindow） |
| 浏览保存路径 / 打开文件夹 | `browse_logcat_save_path()` / `open_logcat_folder()` | test_operations.py |

#### 唤醒监测

| UI 操作 | 调用方法 | 文件 |
|---------|----------|------|
| 开始监测 | `start_hotword_monitor()` | ui_components.py |
| 停止监测 | `stop_hotword_monitor()` | ui_components.py |
| 重置计数 | `reset_hotword_count()` | ui_components.py |

#### 系统指令

| UI 操作 | 调用方法 | 文件 |
|---------|----------|------|
| 预设按钮（dumpsys/tinymix/getprop 等） | `open_system_cmd_window(title, shell_cmd)` | ui_components.py |
| 自定义：添加 / 运行 / 运行选中 / 删除选中 | `_syscmd_add_custom()` / `_syscmd_run_custom()` / `_syscmd_run_selected()` / `_syscmd_delete_selected()` | ui_components.py |
| 自定义：直接执行不弹窗 | `_syscmd_run_one(cmd)` | ui_components.py |
| 设备解锁 | `open_device_unlock_window()` | ui_components.py |

---

### 3.5 常用功能

#### 遥控器

| UI 操作 | 调用方法 | 文件 |
|---------|----------|------|
| 方向键/OK/音量/返回 | `send_keycode(keycode)` | ui_components.py（可继承 test_operations 实现） |
| 系统设置 | `launch_quick_action("系统设置", ("shell", "am start ..."))` | ui_components.py |
| 快捷应用（YouTube/Netflix 等及自定义） | `launch_quick_action(label, spec)` | ui_components.py |
| 适配/配对遥控器 | `adapt_remote_controller()` | test_operations.py |

#### 本地播放

| UI 操作 | 调用方法 | 文件 |
|---------|----------|------|
| 选择文件 | `browse_local_audio_file()` | test_operations.py |
| 播放 / 停止 | `play_local_audio()` / `stop_local_audio()` | ui_components.py（pygame） |
| 调整音量 | `update_volume()` | test_operations.py |

#### 截图功能

| UI 操作 | 调用方法 | 文件 |
|---------|----------|------|
| 截图 | `take_screenshot()` | test_operations.py |
| 打开截图目录 | `open_screenshot_folder()` | test_operations.py |
| 浏览保存路径 | `browse_screenshot_save_path()` | test_operations.py |

---

### 3.6 烧大象key

#### u盘烧key

| UI 操作 | 调用方法 | 文件 |
|---------|----------|------|
| 就绪 / 获取 UUID / 烧Key / 检查 / 打开日志 / 打开目录 | `setup_ukey_burn_tab()` 内局部：`do_get_uuid`、`do_burn`、`do_check`、`_open_folder`、`_open_log` 等 | ui_components.py |
| 依赖 | `_elevoc_init()`、`_prepare_elevoc_workdir()`、`get_adb_command()` | ui_components.py + devices_operations.py |

#### sn烧key（烧elevockey + 重写设备SN）

| UI 操作 | 调用方法 | 文件 |
|---------|----------|------|
| 获取SN | 局部 `_do_get_sn()`（adb get-serialno） | ui_components.py（setup_sn_key_burn_tab 内） |
| 检查支持 | 局部 `_do_check_support()`（adb shell cat unifykeys/list） | ui_components.py |
| 读取当前key | 局部 `_do_read_current()`（adb shell 读 unifykeys/read） | ui_components.py |
| 写入/替换(烧key) | 局部 `_do_burn()`（adb shell 写 unifykeys/write） | ui_components.py |
| 重写设备SN 子页 | 同页内另一 Notebook 页，逻辑同在 `setup_sn_key_burn_tab()` | ui_components.py |

说明：sn烧key 的 ADB 流程全部在 `ui_components.py` 的 `setup_sn_key_burn_tab()` 内用局部函数 `_do_*` + `_run_in_thread()` 完成，未再下沉到 test_operations。

---

## 四、自定义 HAL 录音（若存在独立入口）

| UI 操作 | 调用方法 | 文件 |
|---------|----------|------|
| 添加/删除/清空/重置属性 | `add_custom_prop()` / `remove_custom_prop()` / `clear_custom_props()` / `reset_custom_props()` | test_operations.py |
| 创建目录 / 检查目录 | `create_custom_dir()` / `check_custom_dir()` | test_operations.py |
| 开始/停止录音 | `start_custom_recording()` / `stop_custom_recording()` | test_operations.py |
| 刷新/拉取/删除文件 | `refresh_custom_files()` / `pull_custom_files()` / `delete_custom_files()` | test_operations.py |

---

## 五、典型调用链示例

1. **HAL 停止录音 → 拉取文件**  
   用户点「停止录音」 → `stop_hal_recording()`（test_operations）→ 后台线程：关属性 → `_auto_pull_hal_files_impl()` → 用 `_safe_update_info()` / `_safe_set_hal_status()` 回写 UI；`get_adb_command()` 来自 devices_operations。

2. **系统指令预设按钮**  
   用户点「dumpsys media.audio_policy」→ `open_system_cmd_window("dumpsys media.audio_policy", "dumpsys media.audio_policy")`（ui_components）→ 弹窗内用 `get_adb_command()` 取序列号，再 `subprocess.run(["adb", "-s", serial, "shell", ...])`。

3. **遥控器按键**  
   用户点「↑」→ `send_keycode("DPAD_UP")`（ui_components）→ 内部调 `get_adb_command("shell input keyevent KEYCODE_DPAD_UP")` 并执行；若 ui 未实现则可能落在 test_operations 的 `send_keycode()`。

4. **烧elevockey 写入**  
   用户点「写入/替换(烧key)」→ `_do_burn()`（ui_components 局部）→ `_ensure_device()` 用 `check_device_selected()`、`device_var` → `_adb_shell(serial, "echo key > ...")`，无 test_operations 参与。

---

## 六、文件职责速查

| 文件 | 职责 |
|------|------|
| **main.py** | 启动 Tk、创建 root、实例化 AudioTestTool、mainloop |
| **audio_test_tool.py** | 定义 AudioTestTool = UIComponents + DeviceOperations + TestOperations，初始化 root/样式/图标 |
| **ui_components.py** | 主/子标签页、所有 setup_*_tab、按钮 command 绑定、弹窗、烧大象 key 的 UI 与 elevockey/SN 逻辑 |
| **test_operations.py** | 麦克风/Loopback/扫频/HAL/Logcat/喇叭/多声道/截图/遥控器适配等具体测试与拉取逻辑 |
| **devices_operations.py** | 设备列表刷新、当前设备、`get_adb_command()`、`check_device_selected()` |
| **feature_config.py** | MAIN_TABS / SUB_TABS 功能开关 |
| **output_paths.py** | output 根目录及 logcat、screenshots、hal_dump 等子目录路径 |

以上整理后，从「大类 → 小类 → 按钮 → 方法 → 文件」和「UI → 业务 → 设备」两条线都可以快速对账。
